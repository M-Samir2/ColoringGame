<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Coloring Game</title>

<style>
body{margin:0;font-family:Arial;background:#222;color:#fff}
.screen{display:none;height:100vh}
button{border:none;border-radius:8px;padding:8px 10px;font-size:14px;cursor:pointer}
h2{text-align:center;margin:10px}

/* ===== PROFILES ===== */
#profiles{padding:15px}
.profile{background:#333;padding:12px;margin:8px;border-radius:8px;cursor:pointer;text-align:center}

/* ===== HOME ===== */
#home{padding:10px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px}
.grid img{width:100%;border-radius:10px;cursor:pointer}

/* ===== EDITOR ===== */
#editor{display:flex;flex-direction:column}
#top{display:flex;gap:6px;background:#111;padding:6px}
#top button{flex:1}

#canvasBox{
  flex:1;
  background:#333;
  overflow:hidden;
  touch-action:none;
  position:relative;
}
canvas{
  background:#fff;
  display:block;
  margin:auto;
  transform-origin:0 0;
  touch-action:none;
}

#tools{
  background:#111;
  padding:6px;
  display:flex;
  flex-direction:column;
  gap:6px;
}

/* tools row */
.toolsRow{
  display:flex;
  gap:6px;
  justify-content:center;
}

/* colors */
#colors{
  display:grid;
  grid-template-columns:repeat(6, 1fr);
  gap:6px;
  justify-items:center;
}
.color{
  width:28px;
  height:28px;
  border-radius:50%;
  border:2px solid #555;
  user-select:none;
  cursor:pointer;
}
.color.active{
  border:3px solid #fff;
  transform:translateY(-2px);
}

/* range */
input[type=range]{width:100%}
</style>
</head>

<body>

<!-- ===== PROFILES ===== -->
<div id="profiles" class="screen">
<h2>Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø±ÙˆÙØ§ÙŠÙ„</h2>
<div id="profileList"></div>
<input id="profileInput" placeholder="Ø§Ø³Ù… Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø¬Ø¯ÙŠØ¯" autocomplete="off">
<button onclick="createProfile()">Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø±ÙˆÙØ§ÙŠÙ„</button>
</div>

<!-- ===== HOME ===== -->
<div id="home" class="screen">
<h2 id="profileTitle"></h2>

<button onclick="openBlank()">ğŸ–Œï¸ Ù„ÙˆØ­Ø© ÙØ§Ø¶ÙŠØ©</button>
<input type="file" accept="image/*" onchange="addImage(this)">

<h3>Ø§Ù„ØµÙˆØ±</h3>
<div class="grid" id="gallery"></div>

<h3>Ø§Ù„Ø£Ù„Ø¨ÙˆÙ… (Ù…Ø­ÙÙˆØ¸Ø§Øª)</h3>
<div class="grid" id="savedGallery"></div>

<button onclick="goProfiles()">ØªØºÙŠÙŠØ± Ø¨Ø±ÙˆÙØ§ÙŠÙ„</button>
</div>

<!-- ===== EDITOR ===== -->
<div id="editor" class="screen">
<div id="top">
<button onclick="backHome()">ğŸ </button>
<button onclick="undo()">â†©ï¸</button>
<button onclick="save()">ğŸ’¾</button>
<button onclick="zoomIn()">ğŸ”+</button>
<button onclick="zoomOut()">ğŸ”-</button>
</div>

<div id="canvasBox">
<canvas id="canvas"></canvas>
</div>

<div id="tools">
<div class="toolsRow">
<button onclick="setTool('brush')">ğŸ–Œï¸</button>
<button onclick="setTool('bucket')">ğŸª£</button>
<button onclick="setTool('eraser')">ğŸ§½</button>
<button onclick="enhance()">âœ¨</button>
</div>

<input type="range" min="2" max="40" value="10" id="size">

<div id="colors"></div>
</div>
</div>

<script>
/* ================== SCREEN CONTROL ================== */
const profiles = document.getElementById("profiles");
const profileList = document.getElementById("profileList");
const profileInput = document.getElementById("profileInput");
const home = document.getElementById("home");
const profileTitle = document.getElementById("profileTitle");
const gallery = document.getElementById("gallery");
const savedGallery = document.getElementById("savedGallery");
const editor = document.getElementById("editor");
const colorsDiv = document.getElementById("colors");
const canvasBox = document.getElementById("canvasBox");
const size = document.getElementById("size");

const screens={
 profiles:profiles,
 home:home,
 editor:editor
};
function show(name){
 Object.values(screens).forEach(s=>s.style.display="none");
 screens[name].style.display="block";
}

/* ================== PROFILES ================== */
let currentProfile="";
function getProfiles(){
 return JSON.parse(localStorage.getItem("profiles")||"[]");
}
function loadProfiles(){
 profileList.innerHTML="";
 getProfiles().forEach(p=>{
  let d=document.createElement("div");
  d.className="profile";
  d.textContent=p;
  d.onclick=()=>selectProfile(p);
  profileList.appendChild(d);
 });
}
function createProfile(){
 let n=profileInput.value.trim();
 if(!n)return;
 let p=getProfiles();
 if(p.includes(n)){
   alert("Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹");
   return;
 }
 p.push(n);
 localStorage.setItem("profiles",JSON.stringify(p));
 localStorage.setItem("data_"+n,JSON.stringify({images:[],saved:[]}));
 profileInput.value="";
 loadProfiles();
}
function selectProfile(p){
 currentProfile=p;
 profileTitle.textContent=p;
 loadHome();
 show("home");
}
function goProfiles(){show("profiles");}

/* ================== HOME ================== */
const baseImages=["images/1.png","images/2.png","images/3.png"];

function loadHome(){
 gallery.innerHTML="";
 savedGallery.innerHTML="";
 let data=JSON.parse(localStorage.getItem("data_"+currentProfile));

 [...baseImages,...data.images].forEach(src=>{
  let i=new Image();
  i.src=src;
  i.onclick=()=>openImage(src);
  gallery.appendChild(i);
 });

 data.saved.forEach(src=>{
  let i=new Image();
  i.src=src;
  i.onclick=()=>openImage(src);
  savedGallery.appendChild(i);
 });
}

function addImage(inp){
 let r=new FileReader();
 r.onload=e=>{
  let d=JSON.parse(localStorage.getItem("data_"+currentProfile));
  d.images.push(e.target.result);
  localStorage.setItem("data_"+currentProfile,JSON.stringify(d));
  loadHome();
 };
 r.readAsDataURL(inp.files[0]);
}

/* ================== EDITOR ================== */
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
let tool="brush";
let drawing=false;
let color="#000";
let undoStack=[];

let scale = 1;            // Ù…ØªØºÙŠØ± Ø§Ù„Ø²ÙˆÙ…
let currentImg = null;    // Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ (null Ù„Ùˆ Ù„ÙˆØ­Ø© ÙØ§Ø¶ÙŠØ©)

let lastTouchDist = null;  // Ù„Ù…Ø³Ø§ÙØ© Ø¢Ø®Ø± Ø­Ø±ÙƒØ© Ù„Ù„Ø¥ØµØ¨Ø¹ÙŠÙ† (Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø²ÙˆÙ…)

/* size */
size.oninput = e => ctx.lineWidth = e.target.value;

/* colors */
const colorList=["#000","#f00","#0f0","#00f","#ff0","#0ff","#f0f","#ffa500","#8a2be2","#964b00","#fff","#888"];
colorList.forEach((c,i)=>{
 let d=document.createElement("div");
 d.className="color";
 d.style.background=c;
 d.onclick=()=>{
  document.querySelectorAll(".color").forEach(x=>x.classList.remove("active"));
  d.classList.add("active");
  color=c;
 };
 colorsDiv.appendChild(d);
});

// ÙØ¹Ù„ Ø£ÙˆÙ„ Ù„ÙˆÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
color = colorList[0];
colorsDiv.children[0].classList.add("active");

/* ======= TOUCH PINCH ZOOM ======= */
canvas.addEventListener('touchstart', function(e){
 if(e.touches.length === 2){
  e.preventDefault();
  lastTouchDist = getTouchDist(e.touches);
 }
},{passive:false});

canvas.addEventListener('touchmove', function(e){
 if(e.touches.length === 2){
  e.preventDefault();
  let newDist = getTouchDist(e.touches);
  if(lastTouchDist){
   let diff = newDist - lastTouchDist;
   if(Math.abs(diff) > 5){
    if(diff > 0){
     zoomInTouch();
    } else {
     zoomOutTouch();
    }
    lastTouchDist = newDist;
   }
  }
 }
},{passive:false});

canvas.addEventListener('touchend', function(e){
 if(e.touches.length < 2){
  lastTouchDist = null;
 }
},{passive:false});

function getTouchDist(touches){
 let dx = touches[0].clientX - touches[1].clientX;
 let dy = touches[0].clientY - touches[1].clientY;
 return Math.sqrt(dx*dx + dy*dy);
}

function zoomInTouch(){
 if(!currentImg) return;
 scale *= 1.1;
 if(scale > 10) scale=10;
 canvas.width = currentImg.width * scale;
 canvas.height = currentImg.height * scale;
 drawImageOnCanvas();
}
function zoomOutTouch(){
 if(!currentImg) return;
 scale /= 1.1;
 if(scale < 0.2) scale=0.2;
 canvas.width = currentImg.width * scale;
 canvas.height = currentImg.height * scale;
 drawImageOnCanvas();
}

/* ====== DRAW EVENTS WITH SCALE ====== */
canvas.onmousedown = e => {
 drawing = true;
 ctx.beginPath();
 const rect = canvas.getBoundingClientRect();
 const x = (e.clientX - rect.left) / scale;
 const y = (e.clientY - rect.top) / scale;
 ctx.moveTo(x,y);
 undoStack.push(canvas.toDataURL());
};
canvas.onmousemove = e => {
 if(!drawing) return;
 const rect = canvas.getBoundingClientRect();
 const x = (e.clientX - rect.left) / scale;
 const y = (e.clientY - rect.top) / scale;
 if(tool === "brush"){
  ctx.strokeStyle = color;
  ctx.lineCap = "round";
  ctx.lineTo(x,y);
  ctx.stroke();
 }
 if(tool === "eraser"){
  ctx.clearRect(x - ctx.lineWidth/2, y - ctx.lineWidth/2, ctx.lineWidth, ctx.lineWidth);
 }
};
canvas.onmouseup = () => drawing = false;
canvas.onmouseleave = () => drawing = false;

canvas.onclick = e => {
 if(tool !== "bucket") return;
 const rect = canvas.getBoundingClientRect();
 const x = (e.clientX - rect.left) / scale;
 const y = (e.clientY - rect.top) / scale;
 bucketFill(Math.floor(x), Math.floor(y));
};

function bucketFill(x,y){
 let img = ctx.getImageData(0,0,canvas.width,canvas.height);
 let d = img.data;
 let i = (y * canvas.width + x) * 4;
 let target = d.slice(i,i+4);
 let fill = hex(color);
 if(match(target,fill)) return;

 let stack = [[x,y]];
 while(stack.length){
  let [cx,cy] = stack.pop();
  if(cx < 0 || cy < 0 || cx >= canvas.width || cy >= canvas.height) continue;
  let ii = (cy * canvas.width + cx) * 4;
  if(match(d.slice(ii,ii+4),target)){
   d[ii] = fill[0]; d[ii+1] = fill[1]; d[ii+2] = fill[2]; d[ii+3] = 255;
   stack.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);
  }
 }
 ctx.putImageData(img,0,0);
}

function enhance(){
 let img = ctx.getImageData(0,0,canvas.width,canvas.height);
 let d = img.data;
 for(let i=0; i<d.length; i+=4){
  if(d[i]<240||d[i+1]<240||d[i+2]<240){
   d[i]=0; d[i+1]=0; d[i+2]=0;
  }
 }
 ctx.putImageData(img,0,0);
 alert("ØªÙ… ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø­ÙˆØ§Ù");
}

function hex(h){
 let c = parseInt(h.slice(1),16);
 return [(c>>16)&255,(c>>8)&255,c&255,255];
}
function match(a,b){
 return a[0] === b[0] && a[1] === b[1] && a[2] === b[2];
}

/* editor actions */
function undo(){
 if(!undoStack.length) return;
 let img = new Image();
 img.src = undoStack.pop();
 img.onload = () => ctx.drawImage(img,0,0);
}
function save(){
 let d = JSON.parse(localStorage.getItem("data_"+currentProfile));
 d.saved.push(canvas.toDataURL());
 localStorage.setItem("data_"+currentProfile,JSON.stringify(d));
 alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
}
function openImage(src){
 show("editor");
 let img = new Image();
 img.src = src;
 img.onload = () => {
  currentImg = img;
  scale = 1;
  canvas.width = img.width;
  canvas.height = img.height;
  drawImageOnCanvas();
 };
}
function drawImageOnCanvas(){
 ctx.clearRect(0,0,canvas.width,canvas.height);
 if(currentImg){
  ctx.save();
  ctx.scale(scale,scale);
  ctx.drawImage(currentImg,0,0);
  ctx.restore();
 } else {
  ctx.fillStyle = "#fff";
  ctx.fillRect(0,0,canvas.width,canvas.height);
 }
}

function openBlank(){
 show("editor");
 canvas.width = 600;
 canvas.height = 600;
 currentImg = null;
 scale = 1;
 drawImageOnCanvas();

 // ÙØ¹Ù„ Ø£ÙˆÙ„ Ù„ÙˆÙ† ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø¹Ø´Ø§Ù† ØªØ¸Ù‡Ø± ÙˆØªØ´ØªØºÙ„
 color = colorList[0];
 document.querySelectorAll(".color").forEach(x => x.classList.remove("active"));
 document.querySelectorAll(".color")[0].classList.add("active");
}

function backHome(){
 if(confirm("Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø¯ÙˆÙ† Ø­ÙØ¸ØŸ")){
  show("home");
 }
}

/* ======= Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø²ÙˆÙ… ======= */
function zoomIn(){
 if(!currentImg) return;
 scale *= 1.2;
 if(scale > 10) scale = 10;
 canvas.width = currentImg.width * scale;
 canvas.height = currentImg.height * scale;
 drawImageOnCanvas();
}
function zoomOut(){
 if(!currentImg) return;
 scale /= 1.2;
 if(scale < 0.2) scale = 0.2;
 canvas.width = currentImg.width * scale;
 canvas.height = currentImg.height * scale;
 drawImageOnCanvas();
}

/* ===== Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ¯ ===== */
function setTool(t){
 tool = t;
}

/* ================== START ================== */
loadProfiles();
show("profiles");
</script>

</body>
</html>
