<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Ù„ÙˆØ­Ø© ØªÙ„ÙˆÙŠÙ† Ù…ØªÙƒØ§Ù…Ù„Ø©</title>

<style>
body {
  margin:0; padding:0; font-family: Arial, sans-serif;
  background:#222; color:#fff;
  display:flex; flex-direction: column; height: 100vh;
}
#profiles, #home, #editor { display:none; flex-direction: column; height: 100%; }
#profiles.active, #home.active, #editor.active { display:flex; }

#profileList { padding:10px; overflow-y:auto; flex:1; }
.profile {
  background:#333; margin:8px; padding:12px; border-radius:8px;
  cursor:pointer; text-align:center;
}

#gallery, #savedGallery {
  display:flex; flex-wrap:wrap; gap:10px;
  padding:10px; overflow-y:auto;
}
#gallery img, #savedGallery img {
  width:100px; height:100px; object-fit:contain;
  border-radius:10px; cursor:pointer;
}

#top {
  background:#111; padding:8px; display:flex; gap:8px; flex-wrap:wrap;
}
button {
  flex:1; background:#333; border:none; color:#fff;
  border-radius:6px; padding:8px;
}
#canvasContainer {
  flex:1; background:#333; margin:8px;
  border-radius:10px; overflow:hidden;
  touch-action:none;
}
canvas { border-radius:10px; }

#tools {
  background:#111; padding:8px;
  display:flex; flex-wrap:wrap; gap:8px; justify-content:center;
}
#colors {
  display:grid; grid-template-columns:repeat(8,28px);
  gap:8px;
}
.color {
  width:28px; height:28px; border-radius:50%;
  border:2px solid #555; cursor:pointer;
}
.color.active {
  border:3px solid #0af;
}
</style>
</head>

<body>

<!-- PROFILES -->
<div id="profiles" class="active">
  <h2 style="text-align:center">Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø±ÙˆÙØ§ÙŠÙ„</h2>
  <div id="profileList"></div>
  <input id="profileInput" placeholder="Ø§Ø³Ù… Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø¬Ø¯ÙŠØ¯" />
  <button onclick="createProfile()">Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø±ÙˆÙØ§ÙŠÙ„</button>
</div>

<!-- HOME -->
<div id="home">
  <h2 id="profileTitle" style="text-align:center"></h2>
  <button onclick="openBlank()">ğŸ–Œï¸ Ù„ÙˆØ­Ø© ÙØ§Ø¶ÙŠØ©</button>
  <input type="file" accept="image/*" onchange="addImage(event)">
  <button onclick="goProfiles()">ØªØºÙŠÙŠØ± Ø¨Ø±ÙˆÙØ§ÙŠÙ„</button>

  <h3>Ø§Ù„ØµÙˆØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
  <div id="gallery"></div>

  <h3>Ø§Ù„Ø£Ù„Ø¨ÙˆÙ…</h3>
  <div id="savedGallery"></div>
</div>

<!-- EDITOR -->
<div id="editor">
  <div id="top">
    <button onclick="backHome()">ğŸ </button>
    <button onclick="undo()">â†©ï¸</button>
    <button onclick="redo()">â†ªï¸</button>
    <button onclick="setTool('brush')">ğŸ–Œï¸</button>
    <button onclick="setTool('bucket')">ğŸª£</button>
    <button onclick="setTool('eraser')">ğŸ§½</button>
    <button onclick="enhance()">âœ¨</button>
    <button onclick="zoom(1.1)">â•</button>
    <button onclick="zoom(0.9)">â–</button>
    <button onclick="save()">ğŸ’¾</button>
  </div>

  <div id="canvasContainer">
    <canvas id="canvas"></canvas>
  </div>

  <div id="tools">
    <div id="colors"></div>
    <input type="range" min="2" max="40" value="10" id="size">
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script>
(() => {

const screens = {
  profiles: document.getElementById("profiles"),
  home: document.getElementById("home"),
  editor: document.getElementById("editor")
};

function showScreen(name){
  Object.values(screens).forEach(s=>s.classList.remove("active"));
  screens[name].classList.add("active");
}

const canvasEl = document.getElementById("canvas");
const container = document.getElementById("canvasContainer");
const fabricCanvas = new fabric.Canvas(canvasEl, {
  isDrawingMode:true,
  backgroundColor:"#fff",
  selection:false
});

function resizeCanvas(){
  fabricCanvas.setWidth(container.clientWidth);
  fabricCanvas.setHeight(container.clientHeight);
  fabricCanvas.renderAll();
}

let currentColor="#000";
let undoStack=[], redoStack=[];
let currentTool="brush";
let zoomLevel=1;

fabricCanvas.on("path:created", saveState);

function saveState(){
  undoStack.push(fabricCanvas.toJSON());
  redoStack=[];
}

window.undo=()=>{
  if(undoStack.length<2) return;
  redoStack.push(undoStack.pop());
  fabricCanvas.loadFromJSON(undoStack.at(-1),()=>fabricCanvas.renderAll());
};

window.redo=()=>{
  if(!redoStack.length) return;
  const s=redoStack.pop();
  undoStack.push(s);
  fabricCanvas.loadFromJSON(s,()=>fabricCanvas.renderAll());
};

window.setTool=t=>{
  currentTool=t;
  fabricCanvas.isDrawingMode = t==="brush";
};

fabricCanvas.on("mouse:down",opt=>{
  if(currentTool==="bucket" && opt.target){
    opt.target.set("fill",currentColor);
    fabricCanvas.renderAll();
    saveState();
  }
  if(currentTool==="eraser" && opt.target){
    fabricCanvas.remove(opt.target);
    saveState();
  }
});

window.enhance=()=>{
  fabricCanvas.forEachObject(o=>o.set("strokeWidth",2));
  fabricCanvas.renderAll();
};

window.zoom=f=>{
  zoomLevel=Math.min(Math.max(zoomLevel*f,1),4);
  fabricCanvas.setZoom(zoomLevel);
};

window.save=()=>{
  const dataURL=fabricCanvas.toDataURL();
  const data=getProfileData(currentProfile);
  data.saved.push(dataURL);
  saveProfileData(currentProfile,data);
  loadHome();
  alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
};

/* ğŸ”¥ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù‡Ù†Ø§ ÙÙ‚Ø· ğŸ”¥ğŸ”¥ */
window.openBlank=()=>{
  showScreen("editor");
  requestAnimationFrame(()=>{
    fabricCanvas.clear();
    resizeCanvas();
    fabricCanvas.setBackgroundColor("#fff",fabricCanvas.renderAll.bind(fabricCanvas));
    undoStack=[]; redoStack=[];
    saveState();
  });
};

function openImage(src){
  showScreen("editor");
  requestAnimationFrame(()=>{
    resizeCanvas();
    fabric.Image.fromURL(src,img=>{
      fabricCanvas.clear();
      const s=Math.min(
        fabricCanvas.width/img.width,
        fabricCanvas.height/img.height
      );
      img.scale(s);
      fabricCanvas.setBackgroundImage(img,fabricCanvas.renderAll.bind(fabricCanvas));
      undoStack=[]; redoStack=[];
      saveState();
    },{crossOrigin:"anonymous"});
  });
}

/* Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ (Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ø§Øª + ØµÙˆØ±) ÙƒÙ…Ø§ Ù‡Ùˆ */
let currentProfile=null;
const baseImages=["images/1.png","images/2.png","images/3.png"];

function getProfiles(){return JSON.parse(localStorage.getItem("profiles")||"[]");}
function saveProfiles(p){localStorage.setItem("profiles",JSON.stringify(p));}
function getProfileData(n){return JSON.parse(localStorage.getItem("data_"+n)||'{"images":[],"saved":[]}');}
function saveProfileData(n,d){localStorage.setItem("data_"+n,JSON.stringify(d));}

window.createProfile=()=>{
  const n=profileInput.value.trim();
  if(!n) return;
  const p=getProfiles(); p.push(n);
  saveProfiles(p); saveProfileData(n,{images:[],saved:[]});
  loadProfiles();
};

function loadProfiles(){
  profileList.innerHTML="";
  getProfiles().forEach(p=>{
    const d=document.createElement("div");
    d.className="profile";
    d.textContent=p;
    d.onclick=()=>{currentProfile=p; profileTitle.textContent=p; loadHome(); showScreen("home");};
    profileList.appendChild(d);
  });
}

function loadHome(){
  gallery.innerHTML=""; savedGallery.innerHTML="";
  const d=getProfileData(currentProfile);
  [...baseImages,...d.images].forEach(s=>{
    const i=new Image(); i.src=s; i.onclick=()=>openImage(s);
    gallery.appendChild(i);
  });
  d.saved.forEach(s=>{
    const i=new Image(); i.src=s; i.onclick=()=>openImage(s);
    savedGallery.appendChild(i);
  });
}

window.addImage=e=>{
  const r=new FileReader();
  r.onload=ev=>{
    const d=getProfileData(currentProfile);
    d.images.push(ev.target.result);
    saveProfileData(currentProfile,d);
    loadHome();
  };
  r.readAsDataURL(e.target.files[0]);
};

window.backHome=()=>showScreen("home");

const colors=["#000","#f00","#0f0","#00f","#ff0","#0ff","#f0f","#ffa500","#8a2be2","#964b00","#fff","#888"];
colors.forEach(c=>{
  const d=document.createElement("div");
  d.className="color"; d.style.background=c;
  d.onclick=()=>{
    document.querySelectorAll(".color").forEach(x=>x.classList.remove("active"));
    d.classList.add("active");
    currentColor=c;
    fabricCanvas.freeDrawingBrush.color=c;
  };
  colorsDiv.appendChild(d);
});
colorsDiv.firstChild.classList.add("active");

size.oninput=()=>fabricCanvas.freeDrawingBrush.width=size.value;

loadProfiles();
resizeCanvas();

})();
</script>

</body>
</html>
