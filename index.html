<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coloring Game</title>

<style>
body {
  margin: 0;
  font-family: Arial;
  background: #f2f2f2;
}

.hidden { display: none; }

#profileScreen, #homeScreen, #editorScreen {
  padding: 10px;
}

h2 { text-align: center; }

button {
  padding: 8px 12px;
  margin: 4px;
}

.profileBtn {
  display: block;
  width: 100%;
  margin: 6px 0;
}

canvas {
  width: 100%;
  background: #fff;
  touch-action: none;
}

#colors {
  display: flex;
  overflow-x: auto;
  padding: 6px;
  background: #eee;
}

.color {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  margin: 4px;
  border: 2px solid transparent;
}

.color.active {
  transform: scale(1.2);
  border-color: #000;
}

#tools {
  display: flex;
  justify-content: center;
  gap: 6px;
  margin: 6px 0;
}
</style>
</head>

<body>

<!-- ================= PROFILE SCREEN ================= -->
<div id="profileScreen">
  <h2>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</h2>
  <div id="profilesList"></div>
  <input id="newProfileName" placeholder="Ø§Ø³Ù… Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø¬Ø¯ÙŠØ¯">
  <button onclick="createProfile()">Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø±ÙˆÙØ§ÙŠÙ„</button>
</div>

<!-- ================= HOME SCREEN ================= -->
<div id="homeScreen" class="hidden">
  <h2 id="profileTitle"></h2>
  <button onclick="openEditor()">ğŸ¨ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
  <h3>Ø§Ù„Ø£Ù„Ø¨ÙˆÙ…</h3>
  <div id="album"></div>
  <button onclick="logout()">ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</button>
</div>

<!-- ================= EDITOR SCREEN ================= -->
<div id="editorScreen" class="hidden">
  <div id="tools">
    <button onclick="setTool('brush')">ğŸ–Œï¸</button>
    <button onclick="setTool('bucket')">ğŸª£</button>
    <button onclick="setTool('eraser')">ğŸ§½</button>
    <button onclick="enhance()">âœ¨ ØªØ­Ø³ÙŠÙ†</button>
    <button onclick="undo()">â†©ï¸</button>
    <button onclick="saveImage()">ğŸ’¾</button>
    <button onclick="backHome()">ğŸ </button>
  </div>

  <canvas id="canvas"></canvas>

  <input type="range" min="3" max="30" value="8" id="brushSize">

  <div id="colors"></div>
</div>

<script>
/* ================= PROFILES ================= */
let currentProfile = localStorage.getItem("currentProfile");

function getProfiles(){
  return Object.keys(localStorage)
    .filter(k => k.startsWith("profile_"))
    .map(k => k.replace("profile_",""));
}

function createProfile(){
  const name = document.getElementById("newProfileName").value.trim();
  if(!name) return;
  localStorage.setItem("profile_"+name, JSON.stringify({ images: [] }));
  localStorage.setItem("currentProfile", name);
  location.reload();
}

function selectProfile(name){
  localStorage.setItem("currentProfile", name);
  location.reload();
}

function logout(){
  localStorage.removeItem("currentProfile");
  location.reload();
}

/* ================= UI INIT ================= */
const profileScreen = document.getElementById("profileScreen");
const homeScreen = document.getElementById("homeScreen");
const editorScreen = document.getElementById("editorScreen");

if(!currentProfile){
  const list = document.getElementById("profilesList");
  getProfiles().forEach(p=>{
    const b = document.createElement("button");
    b.className = "profileBtn";
    b.textContent = p;
    b.onclick = ()=>selectProfile(p);
    list.appendChild(b);
  });
}else{
  profileScreen.classList.add("hidden");
  homeScreen.classList.remove("hidden");
  document.getElementById("profileTitle").textContent =
    "Ø¨Ø±ÙˆÙØ§ÙŠÙ„: " + currentProfile;
  loadAlbum();
}

/* ================= ALBUM ================= */
function loadAlbum(){
  const data = JSON.parse(localStorage.getItem("profile_"+currentProfile));
  const album = document.getElementById("album");
  album.innerHTML = "";
  data.images.forEach((img,i)=>{
    const im = new Image();
    im.src = img;
    im.width = 80;
    im.onclick = ()=>openEditor(img);
    album.appendChild(im);
  });
}

/* ================= EDITOR ================= */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
canvas.height = 400;

let tool = "brush";
let drawing = false;
let lastX = 0, lastY = 0;
let brushSize = 8;
let currentColor = "#ff0000";
let history = [];

function openEditor(imgData){
  homeScreen.classList.add("hidden");
  editorScreen.classList.remove("hidden");

  canvas.width = window.innerWidth - 20;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(imgData){
    const img = new Image();
    img.src = imgData;
    img.onload = ()=>ctx.drawImage(img,0,0);
  }
}

function backHome(){
  editorScreen.classList.add("hidden");
  homeScreen.classList.remove("hidden");
}

function setTool(t){ tool = t; }

document.getElementById("brushSize").oninput = e=>{
  brushSize = Math.max(3, e.target.value);
};

/* ================= COLORS ================= */
const palette = [
  "#000","#fff","#f00","#0f0","#00f","#ff0","#0ff",
  "#f0f","#ffa500","#8b4513","#808080","#4b0082"
];

const colorsDiv = document.getElementById("colors");
palette.forEach(c=>{
  const d = document.createElement("div");
  d.className = "color";
  d.style.background = c;
  d.onclick = ()=>{
    document.querySelectorAll(".color").forEach(x=>x.classList.remove("active"));
    d.classList.add("active");
    currentColor = c;
  };
  colorsDiv.appendChild(d);
});

/* ================= DRAW ================= */
function saveState(){
  history.push(canvas.toDataURL());
  if(history.length > 20) history.shift();
}

function undo(){
  if(!history.length) return;
  const img = new Image();
  img.src = history.pop();
  img.onload = ()=>ctx.drawImage(img,0,0);
}

function start(x,y){
  drawing = true;
  saveState();
  lastX = x; lastY = y;
  if(tool==="bucket") floodFill(x,y);
}

function move(x,y){
  if(!drawing || tool==="bucket") return;

  ctx.lineCap = ctx.lineJoin = "round";
  ctx.lineWidth = brushSize;

  if(tool==="eraser"){
    ctx.globalCompositeOperation = "destination-out";
    ctx.strokeStyle = "rgba(0,0,0,1)";
  }else{
    ctx.globalCompositeOperation = "source-over";
    ctx.strokeStyle = currentColor;
  }

  ctx.beginPath();
  ctx.moveTo(lastX,lastY);
  ctx.lineTo(x,y);
  ctx.stroke();

  lastX=x; lastY=y;
}

function stop(){
  drawing=false;
  ctx.globalCompositeOperation="source-over";
}

canvas.addEventListener("mousedown",e=>start(e.offsetX,e.offsetY));
canvas.addEventListener("mousemove",e=>move(e.offsetX,e.offsetY));
canvas.addEventListener("mouseup",stop);
canvas.addEventListener("mouseleave",stop);

canvas.addEventListener("touchstart",e=>{
  const t=e.touches[0], r=canvas.getBoundingClientRect();
  start(t.clientX-r.left, t.clientY-r.top);
});
canvas.addEventListener("touchmove",e=>{
  const t=e.touches[0], r=canvas.getBoundingClientRect();
  move(t.clientX-r.left, t.clientY-r.top);
});
canvas.addEventListener("touchend",stop);

/* ================= FLOOD FILL ================= */
function floodFill(x,y){
  const img = ctx.getImageData(0,0,canvas.width,canvas.height);
  const data = img.data;
  const w = canvas.width;
  const h = canvas.height;

  const idx = (Math.floor(y)*w+Math.floor(x))*4;
  const target = data.slice(idx,idx+4);
  const fill = hexToRgba(currentColor);

  if(match(target,fill)) return;

  const stack=[[Math.floor(x),Math.floor(y)]];
  while(stack.length){
    const [cx,cy]=stack.pop();
    if(cx<0||cy<0||cx>=w||cy>=h) continue;
    const i=(cy*w+cx)*4;
    if(!match(data.slice(i,i+4),target)) continue;
    data.set(fill,i);
    stack.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);
  }
  ctx.putImageData(img,0,0);
}

function hexToRgba(hex){
  hex=hex.replace("#","");
  return [
    parseInt(hex.substr(0,2),16),
    parseInt(hex.substr(2,2),16),
    parseInt(hex.substr(4,2),16),
    255
  ];
}
function match(a,b){
  return a[0]==b[0]&&a[1]==b[1]&&a[2]==b[2]&&a[3]==b[3];
}

/* ================= ENHANCE ================= */
function enhance(){
  ctx.strokeStyle="#000";
  ctx.lineWidth=1;
  ctx.strokeRect(0,0,canvas.width,canvas.height);
}

/* ================= SAVE ================= */
function saveImage(){
  const data = JSON.parse(localStorage.getItem("profile_"+currentProfile));
  data.images.push(canvas.toDataURL("image/png"));
  localStorage.setItem("profile_"+currentProfile, JSON.stringify(data));
  alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ù„Ø¨ÙˆÙ… âœ…");
  backHome();
  loadAlbum();
}
</script>

</body>
</html>
