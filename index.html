<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Ù„ÙˆØ­Ø© ØªÙ„ÙˆÙŠÙ† Ù…ØªÙƒØ§Ù…Ù„Ø©</title>

<style>
  body {
    margin:0; padding:0; font-family: Arial, sans-serif;
    background:#222; color:#fff;
    display:flex; flex-direction: column; height: 100vh;
  }
  #profiles, #home, #editor { display:none; flex-direction: column; height: 100%; }
  #profiles.active, #home.active, #editor.active { display:flex; }
  
  /* Profiles */
  #profileList {
    padding: 10px;
    overflow-y: auto;
    flex:1;
  }
  .profile {
    background: #333; margin:8px; padding:12px; border-radius:8px;
    cursor:pointer; text-align:center; user-select:none;
  }
  
  /* Home */
  #gallery, #savedGallery {
    display: flex; flex-wrap: wrap; gap: 10px; padding:10px; overflow-y: auto; flex:1;
  }
  #gallery img, #savedGallery img {
    width: 100px; height: 100px; object-fit: contain;
    border-radius: 10px; cursor: pointer; border: 2px solid transparent;
  }
  #gallery img.selected, #savedGallery img.selected {
    border-color: #0af;
  }
  
  /* Editor */
  #top {
    background:#111; padding:8px; display:flex; gap:8px; flex-wrap: wrap; user-select:none;
  }
  button {
    flex: 1; background:#333; border:none; color:#fff;
    border-radius: 6px; padding: 8px 12px; font-size: 14px;
    cursor:pointer;
  }
  button:active {
    background:#555;
  }
  
  #canvasContainer {
    flex: 1; background: #333; margin: 8px; position: relative;
    overflow: hidden;
    touch-action: none;
    border-radius: 10px;
  }
  canvas {
    border-radius: 10px;
  }
  
  #tools {
    background:#111; padding:8px; display:flex; flex-wrap: wrap; gap: 8px; justify-content: center;
  }
  
  #colors {
    display: grid; grid-template-columns: repeat(8, 28px); gap: 8px;
    justify-content: center; align-items: center;
  }
  .color {
    width: 28px; height: 28px; border-radius: 50%; border: 2px solid #555;
    cursor: pointer;
  }
  .color.active {
    border: 3px solid #0af;
    transform: translateY(-2px);
  }
  
  input[type=range] {
    width: 100px;
    vertical-align: middle;
  }
  
  /* Scrollbars */
  #profileList::-webkit-scrollbar, #gallery::-webkit-scrollbar, #savedGallery::-webkit-scrollbar {
    width: 6px;
  }
  #profileList::-webkit-scrollbar-thumb, #gallery::-webkit-scrollbar-thumb, #savedGallery::-webkit-scrollbar-thumb {
    background-color: #555; border-radius: 3px;
  }
</style>

</head>
<body>

<!-- ====== PROFILES SCREEN ====== -->
<div id="profiles" class="active">
  <h2 style="text-align:center; padding:8px 0; border-bottom:1px solid #555;">Ø§Ø®ØªØ± Ø¨Ø±ÙˆÙØ§ÙŠÙ„</h2>
  <div id="profileList"></div>
  <input id="profileInput" placeholder="Ø§Ø³Ù… Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø¬Ø¯ÙŠØ¯" style="padding:8px 10px; margin:10px; border-radius:8px; border:none; width: calc(100% - 40px);"/>
  <button onclick="createProfile()">Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
</div>

<!-- ====== HOME SCREEN ====== -->
<div id="home">
  <h2 style="text-align:center; padding:10px 0; border-bottom:1px solid #555;" id="profileTitle"></h2>
  
  <div style="display:flex; justify-content:center; gap:10px; flex-wrap: wrap; padding:10px;">
    <button onclick="openBlank()">ğŸ–Œï¸ Ù„ÙˆØ­Ø© ÙØ§Ø¶ÙŠØ©</button>
    <input type="file" id="imageLoader" accept="image/*" style="display:none" onchange="addImage(event)" />
    <button onclick="document.getElementById('imageLoader').click()">â• Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    <button onclick="goProfiles()">ØªØºÙŠÙŠØ± Ø¨Ø±ÙˆÙØ§ÙŠÙ„</button>
  </div>
  
  <h3 style="margin:10px 10px 5px;">Ø§Ù„ØµÙˆØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
  <div id="gallery"></div>
  
  <h3 style="margin:10px 10px 5px;">Ø§Ù„Ø£Ù„Ø¨ÙˆÙ… (Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª)</h3>
  <div id="savedGallery"></div>
</div>

<!-- ====== EDITOR SCREEN ====== -->
<div id="editor">
  <div id="top">
    <button onclick="backHome()">ğŸ </button>
    <button onclick="undo()">â†©ï¸ ØªØ±Ø§Ø¬Ø¹</button>
    <button onclick="redo()">â†ªï¸ Ø¥Ø¹Ø§Ø¯Ø©</button>
    <button onclick="setTool('brush')">ğŸ–Œï¸ ÙØ±Ø´Ø©</button>
    <button onclick="setTool('bucket')">ğŸª£ Ø¨ÙˆÙƒØª</button>
    <button onclick="setTool('eraser')">ğŸ§½ Ù…Ù…Ø­Ø§Ø©</button>
    <button onclick="enhance()">âœ¨ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø­ÙˆØ§Ù</button>
    <button onclick="zoom(1.1)">â• Ø²ÙˆÙ…</button>
    <button onclick="zoom(0.9)">â– Ø²ÙˆÙ…</button>
  </div>
  
  <div id="canvasContainer">
    <canvas id="canvas"></canvas>
  </div>
  
  <div id="tools">
    <div id="colors"></div>
    <label>Ø­Ø¬Ù… Ø§Ù„ÙØ±Ø´Ø©: <input type="range" min="2" max="40" value="10" id="size"></label>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script>
(() => {
  // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  const profilesScreen = document.getElementById("profiles");
  const homeScreen = document.getElementById("home");
  const editorScreen = document.getElementById("editor");
  const profileList = document.getElementById("profileList");
  const profileInput = document.getElementById("profileInput");
  const profileTitle = document.getElementById("profileTitle");
  const gallery = document.getElementById("gallery");
  const savedGallery = document.getElementById("savedGallery");
  const colorsContainer = document.getElementById("colors");
  const sizeInput = document.getElementById("size");
  
  let currentProfile = null;
  let fabricCanvas = null;
  let currentTool = "brush";
  let currentColor = "#000000";
  let undoStack = [];
  let redoStack = [];
  
  // Ø£Ù„ÙˆØ§Ù† Ø¬Ø§Ù‡Ø²Ø©
  const colorList = ["#000000","#ff0000","#00ff00","#0000ff","#ffff00","#00ffff","#ff00ff","#ffa500","#8a2be2","#964b00","#ffffff","#888888"];
  
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ø§Øª Ù…Ù† LocalStorage
  function getProfiles() {
    return JSON.parse(localStorage.getItem("profiles")||"[]");
  }
  
  // Ø­ÙØ¸ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ø§Øª
  function saveProfiles(profiles) {
    localStorage.setItem("profiles", JSON.stringify(profiles));
  }
  
  // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
  function getProfileData(name) {
    return JSON.parse(localStorage.getItem("data_"+name) || '{"images":[], "saved":[]}');
  }
  
  // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
  function saveProfileData(name, data) {
    localStorage.setItem("data_"+name, JSON.stringify(data));
  }
  
  // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ø§Øª
  function loadProfiles() {
    profileList.innerHTML = "";
    const profiles = getProfiles();
    profiles.forEach(p => {
      const div = document.createElement("div");
      div.className = "profile";
      div.textContent = p;
      div.onclick = () => selectProfile(p);
      profileList.appendChild(div);
    });
  }
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
  window.createProfile = () => {
    const name = profileInput.value.trim();
    if(!name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„");
    let profiles = getProfiles();
    if(profiles.includes(name)) return alert("Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„");
    profiles.push(name);
    saveProfiles(profiles);
    saveProfileData(name, {images:[], saved:[]});
    profileInput.value = "";
    loadProfiles();
  };
  
  // Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø±ÙˆÙØ§ÙŠÙ„
  function selectProfile(name) {
    currentProfile = name;
    profileTitle.textContent = name;
    loadHome();
    showScreen("home");
  }
  
  window.goProfiles = () => {
    showScreen("profiles");
  };
  
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ù† ÙÙˆÙ„Ø¯Ø± images
  const baseImages = ["images/1.png","images/2.png","images/3.png"];
  
  // ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ùˆ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª
  function loadHome() {
    gallery.innerHTML = "";
    savedGallery.innerHTML = "";
    const data = getProfileData(currentProfile);
    
    [...baseImages, ...data.images].forEach(src => {
      const img = document.createElement("img");
      img.src = src;
      img.onclick = () => openImage(src);
      gallery.appendChild(img);
    });
    
    data.saved.forEach(src => {
      const img = document.createElement("img");
      img.src = src;
      img.onclick = () => openImage(src);
      savedGallery.appendChild(img);
    });
  }
  
  // Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
  window.addImage = e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = evt => {
      const data = getProfileData(currentProfile);
      data.images.push(evt.target.result);
      saveProfileData(currentProfile, data);
      loadHome();
    };
    reader.readAsDataURL(file);
  };
  
  // Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ù…Ø­Ø¯Ø¯Ø©
  function showScreen(name) {
    profilesScreen.classList.remove("active");
    homeScreen.classList.remove("active");
    editorScreen.classList.remove("active");
    if(name === "profiles") profilesScreen.classList.add("active");
    else if(name === "home") homeScreen.classList.add("active");
    else if(name === "editor") editorScreen.classList.add("active");
  }
  
  // Ø¥Ø¹Ø¯Ø§Ø¯ Fabric.js
  function initFabric() {
    fabricCanvas = new fabric.Canvas('canvas', {
      isDrawingMode: true,
      backgroundColor: '#fff',
      selection: false,
      preserveObjectStacking: true
    });
    
    fabricCanvas.freeDrawingBrush.width = sizeInput.value;
    fabricCanvas.freeDrawingBrush.color = currentColor;
    
    fabricCanvas.on('path:created', function() {
      saveState();
    });
  }
  
  // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ±Ø§Ø¬Ø¹
  function saveState() {
    redoStack = [];
    const json = fabricCanvas.toJSON();
    undoStack.push(json);
    if(undoStack.length > 50) undoStack.shift(); // Ø­Ø¯ Ù„Ù„ØªØ±Ø§Ø¬Ø¹
  }
  
  // Ø§Ù„ØªØ±Ø§Ø¬Ø¹
  window.undo = () => {
    if(undoStack.length < 2) return;
    redoStack.push(undoStack.pop());
    const lastState = undoStack[undoStack.length - 1];
    fabricCanvas.loadFromJSON(lastState, () => {
      fabricCanvas.renderAll();
    });
  };
  
  // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±Ø§Ø¬Ø¹
  window.redo = () => {
    if(redoStack.length === 0) return;
    const state = redoStack.pop();
    undoStack.push(state);
    fabricCanvas.loadFromJSON(state, () => {
      fabricCanvas.renderAll();
    });
  };
  
  // Ø¶Ø¨Ø· Ø£Ø¯Ø§Ø© Ø§Ù„Ø±Ø³Ù…
  window.setTool = tool => {
    currentTool = tool;
    if(tool === "brush") {
      fabricCanvas.isDrawingMode = true;
      fabricCanvas.freeDrawingBrush.color = currentColor;
      fabricCanvas.freeDrawingBrush.width = sizeInput.value;
      fabricCanvas.selection = false;
    } else if(tool === "eraser") {
      fabricCanvas.isDrawingMode = false;
      fabricCanvas.selection = false;
      // Ø§Ù„Ù…Ù…Ø­Ø§Ø© Ø¨ØªØ­Ø°Ù paths Ø§Ù„Ù„ÙŠ Ø¨Ù†Ù‚Ø± Ø¹Ù„ÙŠÙ‡Ø§
      fabricCanvas.off('mouse:down', eraserHandler);
      fabricCanvas.on('mouse:down', eraserHandler);
    } else if(tool === "bucket") {
      fabricCanvas.isDrawingMode = false;
      fabricCanvas.selection = false;
      fabricCanvas.off('mouse:down', eraserHandler);
      fabricCanvas.off('mouse:down', bucketHandler);
      fabricCanvas.on('mouse:down', bucketHandler);
    }
  };
  
  // Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù…Ù…Ø­Ø§Ø©
  function eraserHandler(opt) {
    if(currentTool !== "eraser") return;
    const target = opt.target;
    if(target && target.type === 'path') {
      fabricCanvas.remove(target);
      saveState();
    }
  }
  
  // Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø¨ÙˆÙƒØª (ØªÙ„ÙˆÙŠÙ† path Ù…Ø®ØªØ§Ø±Ø©)
  function bucketHandler(opt) {
    if(currentTool !== "bucket") return;
    const pointer = fabricCanvas.getPointer(opt.e);
    // Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ path Ø¯Ø§Ø®Ù„ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù†Ù‚Ø±
    let found = null;
    fabricCanvas.forEachObject(obj => {
      if(obj.type === 'path' && obj.containsPoint(pointer)) {
        found = obj;
      }
    });
    if(found) {
      found.set({fill: currentColor});
      fabricCanvas.renderAll();
      saveState();
    }
  }
  
  // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø­ÙˆØ§Ù (ØªØ¸Ù„ÙŠÙ„ paths Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„)
  window.enhance = () => {
    fabricCanvas.forEachObject(obj => {
      if(obj.type === 'path') {
        obj.set({strokeWidth: 2});
      }
    });
    fabricCanvas.renderAll();
    alert("ØªÙ… ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø­ÙˆØ§Ù");
  };
  
  // Ø²ÙˆÙ… Ù…Ø¹ ØªØ­Ø±ÙŠÙƒ
  let zoomLevel = 1;
  let isPanning = false;
  let lastPosX = 0;
  let lastPosY = 0;
  
  function zoom(factor) {
    zoomLevel *= factor;
    zoomLevel = Math.min(Math.max(zoomLevel, 1), 4);
    fabricCanvas.setZoom(zoomLevel);
  }
  
  function panStart(opt) {
    const evt = opt.e;
    if(evt.touches && evt.touches.length === 2) {
      isPanning = true;
      lastPosX = (evt.touches[0].clientX + evt.touches[1].clientX)/2;
      lastPosY = (evt.touches[0].clientY + evt.touches[1].clientY)/2;
    }
  }
  function panMove(opt) {
    if(!isPanning) return;
    const evt = opt.e;
    if(evt.touches && evt.touches.length === 2) {
      const currentX = (evt.touches[0].clientX + evt.touches[1].clientX)/2;
      const currentY = (evt.touches[0].clientY + evt.touches[1].clientY)/2;
      const deltaX = currentX - lastPosX;
      const deltaY = currentY - lastPosY;
      lastPosX = currentX;
      lastPosY = currentY;
      
      fabricCanvas.relativePan(new fabric.Point(deltaX, deltaY));
    }
  }
  function panEnd() {
    isPanning = false;
  }
  
  // Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø£Ù„Ø¨ÙˆÙ…
  window.save = () => {
    const dataURL = fabricCanvas.toDataURL({format:"png"});
    const data = getProfileData(currentProfile);
    data.saved.push(dataURL);
    saveProfileData(currentProfile, data);
    loadHome();
    alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø£Ù„Ø¨ÙˆÙ…");
  };
  
  // ÙØªØ­ ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ø±
  function openImage(src) {
    fabric.Image.fromURL(src, img => {
      fabricCanvas.clear();
      fabricCanvas.setBackgroundImage(img, fabricCanvas.renderAll.bind(fabricCanvas), {
        scaleX: fabricCanvas.width / img.width,
        scaleY: fabricCanvas.height / img.height,
        originX: 'left',
        originY: 'top',
      });
      undoStack = [];
      redoStack = [];
      saveState();
      showScreen("editor");
    }, {crossOrigin: 'anonymous'});
  }
  
  // ÙØªØ­ Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„ÙØ§Ø¶ÙŠØ©
  window.openBlank = () => {
    fabricCanvas.clear();
    fabricCanvas.setBackgroundColor("#fff", fabricCanvas.renderAll.bind(fabricCanvas));
    undoStack = [];
    redoStack = [];
    saveState();
    showScreen("editor");
  };
  
  // Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  window.backHome = () => {
    if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø¯ÙˆÙ† Ø­ÙØ¸ØŸ")) {
      showScreen("home");
    }
  };
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ù„ÙˆØ§Ù† ÙÙŠ Ø§Ù„Ø£Ø¯ÙˆØ§Øª
  function loadColors() {
    colorsContainer.innerHTML = "";
    colorList.forEach(c => {
      const div = document.createElement("div");
      div.className = "color";
      div.style.backgroundColor = c;
      div.onclick = () => {
        document.querySelectorAll(".color").forEach(x => x.classList.remove("active"));
        div.classList.add("active");
        currentColor = c;
        if(currentTool === "brush") {
          fabricCanvas.freeDrawingBrush.color = currentColor;
        }
      };
      colorsContainer.appendChild(div);
    });
    colorsContainer.firstChild.classList.add("active");
  }
  
  // Ø¶Ø¨Ø· Ø­Ø¬Ù… Ø§Ù„ÙØ±Ø´Ø©
  sizeInput.oninput = () => {
    if(currentTool === "brush") {
      fabricCanvas.freeDrawingBrush.width = parseInt(sizeInput.value,10);
    }
  };
  
  // Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù†ÙØ³ ÙˆØªÙ‡ÙŠØ¦Ø© fabric
  function resizeCanvas() {
    const container = document.getElementById("canvasContainer");
    fabricCanvas.setWidth(container.clientWidth);
    fabricCanvas.setHeight(container.clientHeight);
  }
  
  // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
  function start() {
    loadProfiles();
    showScreen("profiles");
    initFabric();
    loadColors();
    resizeCanvas();
    setTool("brush");
    
    // Ø£Ø­Ø¯Ø§Ø« Ù„Ù…Ø³ Ø§Ù„Ø²ÙˆÙ… ÙˆØ§Ù„ØªØ­Ø±ÙŠÙƒ
    fabricCanvas.on('touch:gesture', function(opt) {
      if(opt.e.touches && opt.e.touches.length === 2) {
        const scale = fabricCanvas.getZoom() * opt.self.scale;
        fabricCanvas.setZoom(Math.min(Math.max(scale, 1), 4));
        opt.e.preventDefault();
      }
    });
    
    fabricCanvas.on('touch:drag', function(opt) {
      if(opt.e.touches && opt.e.touches.length === 2) {
        fabricCanvas.relativePan(new fabric.Point(opt.self.deltaX, opt.self.deltaY));
        opt.e.preventDefault();
      }
    });
    
    window.addEventListener('resize', () => {
      resizeCanvas();
    });
  }
  
  start();
})();
</script>

</body>
</html>
