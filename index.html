<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0">
<title>Coloring Game</title>

<style>
body{margin:0;font-family:Arial;background:#222;color:#fff}
.screen{display:none;height:100vh}
button{border:none;border-radius:8px;padding:8px 10px;font-size:14px}
h2{text-align:center;margin:10px}

#profiles{padding:15px}
.profile{background:#333;padding:12px;margin:8px;border-radius:8px;text-align:center}

#home{padding:10px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px}
.grid img{width:100%;border-radius:10px}

#editor{display:flex;flex-direction:column}
#top{display:flex;gap:6px;background:#111;padding:6px}
#top button{flex:1}

#canvasBox{
 flex:1;
 background:#333;
 overflow:hidden;
 touch-action:none;
}

canvas{
 background:#fff;
 display:block;
 margin:auto;
 transform-origin:0 0;
}

#tools{
 background:#111;
 padding:6px;
 display:flex;
 flex-direction:column;
 gap:6px;
}

.toolsRow{display:flex;gap:6px;justify-content:center}

#colors{
 display:grid;
 grid-template-columns:repeat(6,1fr);
 gap:6px;
 justify-items:center;
}

.color{
 width:28px;height:28px;border-radius:50%;
 border:2px solid #555;
}

.color.active{border:3px solid #fff}
input[type=range]{width:100%}
</style>
</head>

<body>

<div id="profiles" class="screen">
<h2>Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø±ÙˆÙØ§ÙŠÙ„</h2>
<div id="profileList"></div>
<input id="profileInput" placeholder="Ø§Ø³Ù… Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø¬Ø¯ÙŠØ¯">
<button onclick="createProfile()">Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø±ÙˆÙØ§ÙŠÙ„</button>
</div>

<div id="home" class="screen">
<h2 id="profileTitle"></h2>
<button onclick="openBlank()">ğŸ–Œï¸ Ù„ÙˆØ­Ø© ÙØ§Ø¶ÙŠØ©</button>
<input type="file" accept="image/*" onchange="addImage(this)">
<h3>Ø§Ù„ØµÙˆØ±</h3>
<div class="grid" id="gallery"></div>
<h3>Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª</h3>
<div class="grid" id="savedGallery"></div>
<button onclick="goProfiles()">ØªØºÙŠÙŠØ± Ø¨Ø±ÙˆÙØ§ÙŠÙ„</button>
</div>

<div id="editor" class="screen">
<div id="top">
<button onclick="backHome()">ğŸ </button>
<button onclick="undo()">â†©ï¸</button>
<button onclick="save()">ğŸ’¾</button>
</div>

<div id="canvasBox">
<canvas id="canvas"></canvas>
</div>

<div id="tools">
<div class="toolsRow">
<button onclick="setTool('brush')">ğŸ–Œï¸</button>
<button onclick="setTool('bucket')">ğŸª£</button>
<button onclick="setTool('eraser')">ğŸ§½</button>
<button onclick="enhance()">âœ¨</button>
</div>

<div class="toolsRow">
<button onclick="zoomIn()">â•</button>
<button onclick="zoomOut()">â–</button>
</div>

<input type="range" min="2" max="40" value="10" id="size">
<div id="colors"></div>
</div>
</div>

<script>
/* ===== SCREEN ===== */
const screens={profiles,home,editor};
function show(n){
 Object.values(screens).forEach(s=>s.style.display="none");
 screens[n].style.display="block";
}

/* ===== PROFILES ===== */
let currentProfile="";
function getProfiles(){return JSON.parse(localStorage.getItem("profiles")||"[]");}
function loadProfiles(){
 profileList.innerHTML="";
 getProfiles().forEach(p=>{
  let d=document.createElement("div");
  d.className="profile";
  d.textContent=p;
  d.onclick=()=>selectProfile(p);
  profileList.appendChild(d);
 });
}
function createProfile(){
 let n=profileInput.value.trim();
 if(!n)return;
 let p=getProfiles();p.push(n);
 localStorage.setItem("profiles",JSON.stringify(p));
 localStorage.setItem("data_"+n,JSON.stringify({images:[],saved:[]}));
 profileInput.value="";
 loadProfiles();
}
function selectProfile(p){
 currentProfile=p;
 profileTitle.textContent=p;
 loadHome();
 show("home");
}
function goProfiles(){show("profiles");}

/* ===== HOME ===== */
const baseImages=["images/1.png","images/2.png","images/3.png"];
function loadHome(){
 gallery.innerHTML="";
 savedGallery.innerHTML="";
 let data=JSON.parse(localStorage.getItem("data_"+currentProfile));
 [...baseImages,...data.images].forEach(src=>{
  let i=new Image();
  i.src=src;
  i.onclick=()=>openImage(src);
  gallery.appendChild(i);
 });
 data.saved.forEach(src=>{
  let i=new Image();
  i.src=src;
  i.onclick=()=>openImage(src);
  savedGallery.appendChild(i);
 });
}
function addImage(inp){
 let r=new FileReader();
 r.onload=e=>{
  let d=JSON.parse(localStorage.getItem("data_"+currentProfile));
  d.images.push(e.target.result);
  localStorage.setItem("data_"+currentProfile,JSON.stringify(d));
  loadHome();
 };
 r.readAsDataURL(inp.files[0]);
}

/* ===== EDITOR ===== */
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d",{willReadFrequently:true});
let tool="brush",drawing=false,color="#000",undoStack=[];
let scale=1,lastDist=null;
let tolerance=40; // Ø°ÙƒØ§Ø¡ Ø§Ù„Ø¨ÙˆÙƒØª

size.oninput=e=>ctx.lineWidth=e.target.value;

const colorsArr=["#000","#f00","#0f0","#00f","#ff0","#0ff","#f0f","#ffa500","#8a2be2","#964b00","#fff","#888"];
colorsArr.forEach(c=>{
 let d=document.createElement("div");
 d.className="color";
 d.style.background=c;
 d.onclick=()=>{
  document.querySelectorAll(".color").forEach(x=>x.classList.remove("active"));
  d.classList.add("active");
  color=c;
 };
 colors.appendChild(d);
});

function setTool(t){tool=t;}

function getPos(e){
 let r=canvas.getBoundingClientRect();
 return {
  x:Math.floor((e.clientX-r.left)/scale),
  y:Math.floor((e.clientY-r.top)/scale)
 };
}

/* ===== DRAW (LOCK INSIDE LINES) ===== */
canvas.addEventListener("pointerdown",e=>{
 drawing=true;
 let p=getPos(e);
 ctx.beginPath();
 ctx.moveTo(p.x,p.y);
 undoStack.push(canvas.toDataURL());
});
canvas.addEventListener("pointermove",e=>{
 if(!drawing)return;
 let p=getPos(e);
 let pixel=ctx.getImageData(p.x,p.y,1,1).data;
 let isLine = pixel[0]<60 && pixel[1]<60 && pixel[2]<60;
 if(isLine && tool==="brush") return;

 if(tool==="brush"){
  ctx.strokeStyle=color;
  ctx.lineCap="round";
  ctx.lineTo(p.x,p.y);
  ctx.stroke();
 }
 if(tool==="eraser"){
  ctx.clearRect(p.x-ctx.lineWidth/2,p.y-ctx.lineWidth/2,ctx.lineWidth,ctx.lineWidth);
 }
});
canvas.addEventListener("pointerup",()=>drawing=false);

/* ===== SMART BUCKET ===== */
canvas.addEventListener("click",e=>{
 if(tool!=="bucket")return;
 let p=getPos(e);
 smartFill(p.x,p.y);
});

function colorMatch(a,b){
 return Math.abs(a[0]-b[0])<=tolerance &&
        Math.abs(a[1]-b[1])<=tolerance &&
        Math.abs(a[2]-b[2])<=tolerance;
}

function smartFill(x,y){
 let img=ctx.getImageData(0,0,canvas.width,canvas.height);
 let d=img.data;
 let i=(y*canvas.width+x)*4;
 let target=[d[i],d[i+1],d[i+2]];
 let fill=hexToRGB(color);

 let stack=[[x,y]];
 let count=0,limit=700000;

 while(stack.length){
  if(count++>limit)break;
  let [cx,cy]=stack.pop();
  if(cx<0||cy<0||cx>=canvas.width||cy>=canvas.height)continue;
  let ii=(cy*canvas.width+cx)*4;
  let cur=[d[ii],d[ii+1],d[ii+2]];
  let isLine=cur[0]<60&&cur[1]<60&&cur[2]<60;
  if(isLine)continue;
  if(colorMatch(cur,target)){
   d[ii]=fill[0];d[ii+1]=fill[1];d[ii+2]=fill[2];d[ii+3]=255;
   stack.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);
  }
 }
 ctx.putImageData(img,0,0);
}

function hexToRGB(h){
 let n=parseInt(h.slice(1),16);
 return[(n>>16)&255,(n>>8)&255,n&255];
}

/* ===== ZOOM ===== */
function zoomIn(){scale=Math.min(scale+0.2,4);canvas.style.transform=`scale(${scale})`;}
function zoomOut(){scale=Math.max(scale-0.2,0.5);canvas.style.transform=`scale(${scale})`;}

canvas.addEventListener("touchmove",e=>{
 if(e.touches.length===2){
  let dx=e.touches[0].clientX-e.touches[1].clientX;
  let dy=e.touches[0].clientY-e.touches[1].clientY;
  let dist=Math.hypot(dx,dy);
  if(lastDist){
   scale+= (dist-lastDist)*0.002;
   scale=Math.max(0.5,Math.min(scale,4));
   canvas.style.transform=`scale(${scale})`;
  }
  lastDist=dist;
 }
},{passive:false});
canvas.addEventListener("touchend",()=>lastDist=null);

/* ===== ACTIONS ===== */
function enhance(){
 let img=ctx.getImageData(0,0,canvas.width,canvas.height);
 let d=img.data;
 for(let i=0;i<d.length;i+=4){
  if(d[i]<240||d[i+1]<240||d[i+2]<240){
   d[i]=0;d[i+1]=0;d[i+2]=0;
  }
 }
 ctx.putImageData(img,0,0);
}
function undo(){
 if(!undoStack.length)return;
 let i=new Image();
 i.src=undoStack.pop();
 i.onload=()=>ctx.drawImage(i,0,0);
}
function save(){
 let d=JSON.parse(localStorage.getItem("data_"+currentProfile));
 d.saved.push(canvas.toDataURL());
 localStorage.setItem("data_"+currentProfile,JSON.stringify(d));
 alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
}
function openImage(src){
 show("editor");
 let i=new Image();
 i.src=src;
 i.onload=()=>{
  canvas.width=i.width;
  canvas.height=i.height;
  ctx.drawImage(i,0,0);
 };
}
function openBlank(){
 show("editor");
 canvas.width=600;
 canvas.height=600;
 ctx.fillStyle="#fff";
 ctx.fillRect(0,0,600,600);
}
function backHome(){show("home");}

/* START */
loadProfiles();
show("profiles");
</script>
</body>
</html>
