<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Coloring Game</title>

<style>
body{
 margin:0;
 background:#222;
 color:#fff;
 font-family:Arial;
}
.screen{display:none;height:100vh}
button{border:none;border-radius:8px;padding:8px 12px}
h2{text-align:center}

/* ===== HOME ===== */
#home{padding:10px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px}
.grid img{width:100%;border-radius:10px;cursor:pointer}

/* ===== EDITOR ===== */
#editor{display:flex;flex-direction:column;height:100vh}

#top{
 display:flex;
 gap:6px;
 padding:6px;
 background:#111;
}

#frame{
 flex:1;
 background:#444;
 display:flex;
 justify-content:center;
 align-items:center;
 overflow:hidden;
}

#canvasFrame{
 position:relative;
 border:4px solid #fff;
 background:#ccc;
 touch-action:none;
}

canvas{
 position:absolute;
 top:0;
 left:0;
}

#tools{
 background:#111;
 padding:6px;
 display:flex;
 flex-direction:column;
 gap:6px;
}

.toolsRow{
 display:flex;
 gap:6px;
 justify-content:center;
}

#colors{
 display:grid;
 grid-template-columns:repeat(6,1fr);
 gap:6px;
}

.color{
 width:28px;
 height:28px;
 border-radius:50%;
 border:2px solid #555;
}
.color.active{border:3px solid #fff}

input[type=range]{width:100%}
</style>
</head>

<body>

<div id="home" class="screen">
<h2>Ø§Ø®ØªØ± ØµÙˆØ±Ø©</h2>
<button onclick="openBlank()">ğŸ–Œï¸ Ù„ÙˆØ­Ø© ÙØ§Ø¶ÙŠØ©</button>
<input type="file" accept="image/*" onchange="addImage(this)">
<div class="grid" id="gallery"></div>
</div>

<div id="editor" class="screen">
<div id="top">
<button onclick="backHome()">ğŸ </button>
<button onclick="undo()">â†©ï¸</button>
<button onclick="zoom(1.1)">â•</button>
<button onclick="zoom(0.9)">â–</button>
</div>

<div id="frame">
<div id="canvasFrame">
<canvas id="base"></canvas>
<canvas id="paint"></canvas>
</div>
</div>

<div id="tools">
<div class="toolsRow">
<button onclick="tool='brush'">ğŸ–Œï¸</button>
<button onclick="tool='bucket'">ğŸª£</button>
<button onclick="tool='eraser'">ğŸ§½</button>
</div>

<input type="range" min="5" max="40" value="15" id="size">

<div id="colors"></div>
</div>
</div>

<script>
const gallery=document.getElementById("gallery");
const home=document.getElementById("home");
const editor=document.getElementById("editor");
const frame=document.getElementById("canvasFrame");

const base=document.getElementById("base");
const paint=document.getElementById("paint");

const bctx=base.getContext("2d");
const pctx=paint.getContext("2d");

let tool="brush";
let color="#ff0000";
let drawing=false;
let scale=1;
let undoStack=[];

/* ===== COLORS ===== */
["#000","#f00","#0f0","#00f","#ff0","#0ff","#f0f","#ffa500","#8a2be2","#964b00","#fff","#888"]
.forEach(c=>{
 let d=document.createElement("div");
 d.className="color";
 d.style.background=c;
 d.onclick=()=>{
  document.querySelectorAll(".color").forEach(x=>x.classList.remove("active"));
  d.classList.add("active");
  color=c;
 };
 colors.appendChild(d);
});

/* ===== LOAD IMAGE ===== */
function openImage(src){
 show(editor);
 let img=new Image();
 img.onload=()=>{
  base.width=paint.width=img.width;
  base.height=paint.height=img.height;
  frame.style.width=img.width+"px";
  frame.style.height=img.height+"px";
  bctx.drawImage(img,0,0);
  pctx.clearRect(0,0,paint.width,paint.height);
  undoStack=[];
 };
 img.src=src;
}

function openBlank(){
 show(editor);
 let w=600,h=600;
 base.width=paint.width=w;
 base.height=paint.height=h;
 frame.style.width=w+"px";
 frame.style.height=h+"px";
 bctx.fillStyle="#fff";
 bctx.fillRect(0,0,w,h);
 pctx.clearRect(0,0,w,h);
 undoStack=[];
}

/* ===== DRAW ===== */
paint.addEventListener("pointerdown",e=>{
 drawing=true;
 pctx.lineWidth=size.value;
 pctx.lineCap="round";
 pctx.strokeStyle=color;
 pctx.beginPath();
 pctx.moveTo(e.offsetX,e.offsetY);
 undoStack.push(paint.toDataURL());
});

paint.addEventListener("pointermove",e=>{
 if(!drawing)return;
 if(tool==="brush"){
  pctx.lineTo(e.offsetX,e.offsetY);
  pctx.stroke();
 }
 if(tool==="eraser"){
  pctx.clearRect(e.offsetX-10,e.offsetY-10,20,20);
 }
});

paint.addEventListener("pointerup",()=>drawing=false);

paint.addEventListener("click",e=>{
 if(tool!=="bucket")return;
 bucket(e.offsetX,e.offsetY);
});

/* ===== SMART BUCKET ===== */
function bucket(x,y){
 let img=pctx.getImageData(0,0,paint.width,paint.height);
 let d=img.data;
 let idx=(y*paint.width+x)*4;
 let target=[d[idx],d[idx+1],d[idx+2],d[idx+3]];
 let fill=hexToRGBA(color);
 if(match(target,fill))return;

 let stack=[[x,y]];
 while(stack.length){
  let [cx,cy]=stack.pop();
  if(cx<0||cy<0||cx>=paint.width||cy>=paint.height)continue;
  let i=(cy*paint.width+cx)*4;
  if(match([d[i],d[i+1],d[i+2],d[i+3]],target)){
   d[i]=fill[0];d[i+1]=fill[1];d[i+2]=fill[2];d[i+3]=255;
   stack.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);
  }
 }
 pctx.putImageData(img,0,0);
}

function hexToRGBA(h){
 let n=parseInt(h.slice(1),16);
 return[(n>>16)&255,(n>>8)&255,n&255,255];
}
function match(a,b){
 return a[0]==b[0]&&a[1]==b[1]&&a[2]==b[2];
}

/* ===== ZOOM ===== */
function zoom(v){
 scale*=v;
 scale=Math.max(1,Math.min(scale,4));
 frame.style.transform=`scale(${scale})`;
}

/* ===== UNDO ===== */
function undo(){
 if(!undoStack.length)return;
 let img=new Image();
 img.onload=()=>pctx.drawImage(img,0,0);
 img.src=undoStack.pop();
}

/* ===== HOME ===== */
function addImage(inp){
 let r=new FileReader();
 r.onload=e=>{
  let img=new Image();
  img.src=e.target.result;
  img.onclick=()=>openImage(img.src);
  gallery.appendChild(img);
 };
 r.readAsDataURL(inp.files[0]);
}

function backHome(){
 show(home);
}

/* ===== START ===== */
function show(s){
 home.style.display="none";
 editor.style.display="none";
 s.style.display="block";
}
show(home);
</script>

</body>
</html>
